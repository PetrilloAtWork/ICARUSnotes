Gianluca's understanding of ICARUS PMT readout and data acquisition
====================================================================

Sequence
---------

1. a promise of beam (_early warning_) arrives from one of the accelerators
   to the SPEXI board
2. SPEXI generates the proper beam gate (BNB or NuMI)
    * is it possible that multiple gates are going to overlap? what if? :question:
3. SPEXI message is sent to the readout boards to enable data acquisition
    * for PMT readout, that message enables the readout 1 ms
      before the expected time of arrival of the beam
4. at enable time, each V1730 channel starts filling its first circular buffer
5. since V1730 board "self-triggering mode" is enabled (_[UserManual]_ p. 37):
    * each channel discriminates against every sample (2 ns)
    * discriminated signals are paired (AND/OR) into a _single trigger request_
    * trigger requests are combined into a _board common trigger_
        * there may be up to 8 trigger requests at a time
          (one from each 2-channel pair)
        * at least _N_ requests within _T_ clock ticks (_N - 1_ requests coming
          within _T_ from the first one, _[UserManual]_ p. 42)
6. when a board common trigger is generated, the current circular buffers are
   frozen (_[UserManual]_ p. 32)
    * buffers start filling the "post-trigger" samples
    * after that, all 16 buffers are frozen: new samples are stored in a
      different circular buffer
    * the frozen buffer patiently wait in their memory box
7. "external triggering" is also enabled: during the beam gate, we send trigger
   signals which also cause a board common trigger and freeze the buffers
    * _[Aiwu Zhang]_ the signals are generated by SPEXI and sent to the `TRG IN` port of
      the readout boards (daisy-chained)
    * this ensures that full data for all PMT is acquired during the beam gate
    * the timimg of these additional trigger signals can exceed the beam gate
      lenght
8. the same :question: single trigger request signals that are used to evaluate
   the board common trigger are also sent as LVDS outputs
    * this happens all the time, whether or not the requirements for
      a board common trigger are satisfied
9. LVDS signals from the 12 V1730B readout boards serving each cryostat
   (96 signals) are combined into two _cryostat triggers_ by NI 7820 boards
   (one per cryostat) with programmable logic applied by the board FPGA
10. the two cryostat triggers are combined with the beam gate in a third 
    NI 7820 board to emit the _global trigger_ signal
11. the global trigger decision is communicated to the data acquisition system
12. if the event triggers, DAQ:
    * waits long enough to complete the TPC and PMT readout
    * harvests all V1730B buffers currently in board memory, which enter the
      event building
13. V1730B buffers are flushed, all memory is made available again

:::info
Cryostat trigger logic utilises the LVDS signals corresponding to the single
trigger requests: these triggers are independent of the readout settings
except for the discrimination threshold.
:::


Consequence
------------

* PMT readout covers 2 ms of data acquisition, with focus on the beam gate
  and what preceeds it
* channels are saved into the events in groups of 15 (contiguous PMT)
* activity is saved in units of buffer length (10 µs)
* self-triggering ensures that all activity can be stored in the event,
  even outside the beam gate
* which activity outside the beam gate that is effectively saved depends on the
  board-common trigger configuration; for example:
    * with a _N_ photoelectron threshold on each PMT, single trigger request
      based on OR pairing and a requirement of just one single trigger request:
        * all activity above _N_ photoelectron is recorded, at any time
        * the activity at that same time from channels contiguous to that
          active one is recorded as well
    * the timing of the stored activity is precisely aligned with the activity
      in the triggering ones among the channels, with a delay of up to 6 ns
      (single trigger requests are emitted with the 125 MHz trigger clock)
* the activity inside the beam gate is recorded regardless the threshold,
  by the timely injection of external trigger signals
    * the activity in the beam gate is fully stored, and with some overhead
    * the timing of the stored activity is aligned with the external trigger
      arrival, which should be pretty well synchronised among boards
          

Trigger overlapping
--------------------

Only one global trigger can be generated per event: global triggers can't
overlap.
Board-common triggers can (and often will) overlap:

* when a board-common trigger is received while filling the post-trigger buffer
  (i.e. earlier than 3840 samples after the previous board-common trigger),
  a new buffer is saved and frozen after the current one is _completed_, and the
  new buffer will contain only the excess post-trigger data which has not been
  included into the current buffer (_[UserManual]_ p. 32)
* when a board-common trigger is received soon enough after the previous one
  so that there are not enough samples in the current buffer to meet the
  pre-trigger quota, the new buffer will contain only the existing samples at
  the last board-common trigger time, plus a complete post-trigger window
  (_[Riviera20200208]_)



Summary of V1730B configurations and settings
----------------------------------------------

* there are 24 V1730B readout boards, each serving 15 channels from contiguous
  PMT on a single plane (12 boards per cryostat, 6 for 90 PMT behind each plane)
    * on each board, 14 channels are paired into a single trigger request,
      while one is not paired (plus exceptions for dead/noisy channels)
* ADC sampling period is every 2 ns
* V1730B host 5 MS(megasample) for each of the 16 channels
* each of the 16 channels hosts 1,000 circular buffers, each 5110 S (10 µs) long
  (register `800C`)
* post-trigger buffer size is set to 75% of the buffer (3840 samples);
  pre-trigger buffer constitutes the remaining 25% (1280 samples)
* triggering mode (register `810C`): self triggering _or_ external trigger
* self-triggering mode:
    * channel thresholds for single trigger request are independently
      configured, for transition from above to below threshold (negative signal)
      (registers `1n60` and `1n70`, _n_ from `0` to `F`)
    * the configuration of the board-common trigger has not been chosen yet
      (register `810C`)
* all channel pairs are set to AND or OR (to be decided), except the ones
  which are unpaired (register `1n84`, _n_ from `0` to `7`?)
* :question: every data comes with a reliable absolute time tag sufficient to align
  activity from any channel at digitisation clock level (2 ns)
* overlapping triggers are accepted (register `8000`)



Glossary
---------

board-common trigger
:   local V1730 signal generated from single trigger requests,
    causing the data on the channels to be acquired and kept (not overwritten)

cryostat trigger
:   trigger geneated by NI 7820 based on all PMT input from channels
    in a single cryostat

event trigger
:    see _global trigger_

global trigger
:   (also _event trigger_) trigger generated by the master NI 7820 board
    based on information from the cryostat triggers and the beam information;
    this decides whether the event is acquired and written
    (barred higher level triggers)

single trigger request
:   a configurable signal from two V1730 channels implying that there
    is activity in them



References
-----------

[Riviera20200208]
: from Wesley Ketchum, Gian Luca Raselli and David Riviera on e-mail exchange on April 8, 2020

[Manual]
: CAEN UM2792, _User Manual: V1730/VX1730 & V1725/VX1725 16/8-channel 14-bit 500/250 MS/s Waveform Digitizer_, Rev. 2, June 10, 2016
